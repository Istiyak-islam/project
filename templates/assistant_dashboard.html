<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Assistant Dashboard</title>

    <!-- Bootstrap + jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <style>
        body {
            background: #f4f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            margin-top: 40px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .progress {
            height: 25px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">Lab Assistant - Software Checker & Installer</h2>

    <table class="table table-bordered table-hover">
        <thead class="table-primary">
            <tr>
                <th>#</th>
                <th>Software</th>
                <th>Status</th>
                <th>Action</th>
                <th>Progress</th>
            </tr>
        </thead>
        <tbody>
            {% for software in softwares %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ software.name }}</td>
                <td>
                    {% if software.installed %}
                        <span class="text-success">Installed</span><br>
                        <small>{{ software.path_windows }}</small>
                    {% else %}
                        <span class="text-danger">Not Installed</span>
                    {% endif %}
                </td>
                <td>
                    {% if not software.installed %}
                        {% if software.url_auto_download %}
                            <button class="btn btn-success btn-sm install-btn" data-url="{{ software.url }}" data-name="{{ software.name }}">Install</button>
                        {% else %}
                            <a href="{{ software.url }}" target="_blank" class="btn btn-warning btn-sm">Go to Official Site</a>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-secondary btn-sm" disabled>Installed</button>
                    {% endif %}
                </td>
                <td>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" data-name="{{ software.name }}">0%</div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{{ url_for('logout') }}" class="btn btn-danger mt-3">Logout</a>
</div>

<script>
$(document).ready(function(){

    $('.install-btn').click(function(){
        let button = $(this);
        let url = button.data('url');
        let name = button.data('name');
        let progressBar = $('div.progress-bar[data-name="'+name+'"]');

        button.prop('disabled', true).text('Downloading...');

        // Start download via AJAX
        $.ajax({
            url: "{{ url_for('download_software') }}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ 'url': url, 'name': name }),
            xhrFields: {
                onprogress: function(e) {
                    if(e.lengthComputable){
                        let percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.css('width', percent + '%').text(percent + '%');
                    }
                }
            },
            success: function(data){
                if(data.status == 'success'){
                    progressBar.css('width', '100%').text('Completed');
                    button.text('Installed').removeClass('btn-success').addClass('btn-secondary');
                } else {
                    alert(data.message);
                    button.prop('disabled', false).text('Install');
                }
            },
            error: function(){
                alert('Error occurred while downloading.');
                button.prop('disabled', false).text('Install');
            }
        });
    });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
