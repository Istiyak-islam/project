<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.title }} - Start Exam</title>

    <!-- Bootstrap + jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <style>
        body {
            background: #f4f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            margin-top: 40px;
        }
        .card {
            margin-bottom: 20px;
        }
        .timer {
            font-weight: bold;
            color: red;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">{{ exam.title }} - {{ exam.duration_minutes }} min</h2>

    <!-- Timer Card -->
    <div class="card">
        <div class="card-header bg-warning text-dark">
            Time Remaining
        </div>
        <div class="card-body">
            <p id="timer" class="timer"></p>
        </div>
    </div>

    <!-- Software Selection Card -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            Select Software
        </div>
        <div class="card-body">
            <p>Select a software to write your code. Open it on your PC, write the code, save locally, and upload below.</p>
            <select id="softwareSelect" class="form-select mb-3">
                {% for s in softwares %}
                <option value="{{ s.name }}">{{ s.name }}</option>
                {% endfor %}
            </select>
            <button id="launchSoftware" class="btn btn-primary mb-3">Launch Software</button>
        </div>
    </div>

    <!-- File Submission Card -->
    <div class="card">
        <div class="card-header bg-success text-white">
            Submit Your Work
        </div>
        <div class="card-body">
            <form id="submitForm" enctype="multipart/form-data">
                <input type="hidden" name="exam_id" value="{{ exam.id }}">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">Select File to Submit</label>
                    <input type="file" class="form-control" id="fileInput" name="file" required>
                </div>
                <button type="submit" class="btn btn-success">Submit Exam</button>
            </form>
        </div>
    </div>

    <a href="{{ url_for('student_dashboard') }}" class="btn btn-danger mt-3">Back to Dashboard</a>
</div>

<script>
$(document).ready(function(){

    // Countdown Timer
    let endTime = new Date("{{ exam.end_time }} UTC").getTime();
    let timerInterval = setInterval(function() {
        let now = new Date().getTime();
        let distance = endTime - now;
        if(distance <= 0){
            clearInterval(timerInterval);
            alert("Time is up! Submit your code immediately.");
            window.location.href = "{{ url_for('student_dashboard') }}";
        } else {
            let minutes = Math.floor(distance / 60000);
            let seconds = Math.floor((distance % 60000)/1000);
            document.getElementById("timer").innerHTML = minutes + "m " + seconds + "s remaining";
        }
    }, 1000);

    // Launch software alert
    $('#launchSoftware').click(function(){
        let software = $('#softwareSelect').val();
        alert('Please open ' + software + ' on your PC, write your code, save locally, and then submit using the form below.');
    });

    // Submit Exam
    $('#submitForm').submit(function(e){
        e.preventDefault();
        let formData = new FormData(this);

        $.ajax({
            url: "{{ url_for('submit_exam') }}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(data){
                if(data.status === 'success'){
                    alert('Exam submitted successfully!');
                    window.location.href = "{{ url_for('student_dashboard') }}";
                } else {
                    alert(data.message);
                }
            }
        });
    });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
