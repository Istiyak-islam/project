<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Exam - {{ exam.title }}</title>

    <!-- Bootstrap + jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <style>
        body {
            background: #f4f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            margin-top: 40px;
        }
        .card {
            margin-bottom: 20px;
        }
        .timer {
            font-weight: bold;
            color: red;
            font-size: 1.2rem;
        }
        textarea {
            font-family: monospace;
            font-size: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">{{ exam.title }} - {{ exam.duration_minutes }} min</h2>
    <p>{{ exam.description }}</p>

    <!-- Timer Card -->
    <div class="card">
        <div class="card-header bg-warning text-dark">
            Time Remaining
        </div>
        <div class="card-body">
            <p id="timer" class="timer"></p>
        </div>
    </div>

    <!-- Software Info Card -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            Software Instructions
        </div>
        <div class="card-body">
            <p>Select a software (from start_exam page), open it on your PC, write code, save locally, and upload here.</p>
            <ul>
                {% for s in softwares %}
                <li>{{ s.name }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Submission Card -->
    <div class="card">
        <div class="card-header bg-success text-white">
            Submit Your Work
        </div>
        <div class="card-body">
            <form id="examForm" enctype="multipart/form-data" method="POST">
                <input type="hidden" name="exam_id" value="{{ exam.id }}">

                <div class="mb-3">
                    <label for="codeTextarea" class="form-label">Paste your code (optional if uploading file)</label>
                    <textarea id="codeTextarea" class="form-control" name="code" rows="12"></textarea>
                </div>

                <div class="mb-3">
                    <label for="codeFile" class="form-label">Upload Code File (optional)</label>
                    <input type="file" class="form-control" id="codeFile" name="code_file">
                </div>

                <button type="submit" class="btn btn-success">Submit Exam</button>
            </form>
        </div>
    </div>

    <a href="{{ url_for('student_dashboard') }}" class="btn btn-danger mt-3">Back to Dashboard</a>
</div>

<script>
$(document).ready(function(){

    // Countdown Timer
    let remaining = {{ remaining_time }}; // in seconds
    function startTimer(){
        const timerElem = document.getElementById('timer');
        const interval = setInterval(()=>{
            if(remaining <= 0){
                clearInterval(interval);
                alert("Time is over! Submitting automatically.");
                $('#examForm').submit();
                return;
            }
            let minutes = Math.floor(remaining / 60);
            let seconds = remaining % 60;
            timerElem.innerText = minutes + "m " + seconds + "s remaining";
            remaining--;
        }, 1000);
    }
    startTimer();

    // Optional: AJAX form submission
    $('#examForm').submit(function(e){
        e.preventDefault();
        let formData = new FormData(this);

        $.ajax({
            url: "{{ url_for('take_exam', exam_id=exam.id) }}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(data){
                if(data.status === 'success'){
                    alert('Exam submitted successfully!');
                    window.location.href = "{{ url_for('student_dashboard') }}";
                } else {
                    alert(data.message);
                }
            }
        });
    });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
